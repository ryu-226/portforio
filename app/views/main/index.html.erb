<!-- 予算金額の提示 -->
<main class="flex flex-col items-center justify-start min-h-[80vh] p-10 mb-10 text-gray-700">
  <!-- 未設定アラート -->
  <% if @budget.blank? %>
      <div class="mb-20 px-4 py-2 bg-yellow-50 border border-secondary text-secondary text-sm rounded text-center">
        今月の予算がまだ設定されていません。<br>
        <%= link_to "こちらから設定しましょう！", new_budget_path, class: "text-accent underline hover:text-accent/60 font-semibold" %>
      </div>
  <% end %>

    <% if @remaining_days && @remaining_budget %>
      <div class="mb-10 px-4 py-2 bg-primary/10 rounded-lg text-primary font-bold text-base">
        今月ガチャできる日数: <%= @remaining_days %>日
      </div>
    <% end %>

  <div class="mb-18">
    <h2 class="text-center text-3xl text-secondary font-bold mb-6">今日の予算</h2>
    <div id="today-amount" class="whitespace-nowrap py-4 px-8 mx-auto bg-primary rounded-full shadow-md text-5xl font-extrabold text-white mb-8 cursor-pointer hover:bg-primary/80 transition animate-breath">
      <% if @draw %>
        <%= @draw.amount %> 円
      <% else %>
        <span class="empty-placeholder mr-8"></span>円
      <% end %>
    </div>
  </div>

  <!-- ボタンorテキスト -->
  <% if @budget.present? && @remaining_days.to_i <= 0 %>
    <!-- 残り回数 0：ボタンを出さずに案内だけ -->
    <div class="mt-4 px-4 py-2 bg-yellow-50 border border-secondary text-secondary text-sm rounded text-center">
      今月のガチャできる日数が上限に達しました。<br>
      <%= link_to "設定を変更する", edit_budget_path, class: "text-accent underline hover:text-accent/60 font-semibold" %>
    </div>
  <% elsif !@draw %>
    <!-- まだ今日のガチャを回していない：ボタン表示 -->
    <%= form_with url: draw_main_path, method: :post, local: true do %>
      <div class="relative flex justify-center items-center">
        <!-- ボタン本体 -->
        <button type="submit" class="py-4 px-12 mt-6 rounded-xl text-xl bg-secondary text-white font-bold shadow-xl ring-2 ring-secondary/30 hover:bg-secondary/80 hover:scale-110 transition duration-200 flex items-center gap-4 group z-10 relative min-w-[220px] min-h-[56px] animate-breath">
          <span class="absolute left-8 top-0.5 w-14 h-14 pointer-events-none animate-spin">
            <!-- ガチャハンドルSVG -->
            <svg viewBox="0 0 120 120" class="w-14 h-14" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <marker id="arrowhead" markerUnits="strokeWidth" markerWidth="3" markerHeight="3" refX="0" refY="1.5" orient="auto-start-reverse">
                  <path d="M0,0 L0,3 L3,1.5 Z" fill="#FFE600"/>
                </marker>
                <mask id="cut-inner">
                  <rect width="120" height="120" fill="white"/>
                  <circle cx="60" cy="60" r="40" fill="black"/>
                </mask>
              </defs>
              <circle cx="60" cy="60" r="58" fill="#1766A6"/>
              <g mask="url(#cut-inner)">
                <path d="M105,60 a45,45 0 1,0 -32.5,43" fill="none" stroke="#FFE600" stroke-width="6" stroke-linecap="round" marker-start="url(#arrowhead)"/>
              </g>
              <polygon points="0,-6 0,6 -8,0" fill="#D93628" transform="translate(97.6,88.2) rotate(90)"/>
              <circle cx="60" cy="60" r="40" fill="#F4F4F4"/>
              <ellipse cx="60" cy="70" rx="32" ry="12" fill="#DDD" opacity="0.3"/>
              <rect x="34" y="54" width="52" height="12" rx="6" fill="#FFF" stroke="#D1D1D1" stroke-width="2"/>
              <rect x="40" y="57" width="40" height="6" rx="3" fill="#FFF" opacity="0.7"/>
            </svg>
          </span>
          <span class="pl-16 tracking-wide text-lg md:text-xl">ガチャを回す</span>
        </button>
      </div>
    <% end %>
  <% else %>
    <!-- 今日ぶんは既に回している：既存表示をそのまま -->
    <div class="text-lg text-gray-600 font-semibold animate-pulse">ガチャ済みです</div>
    <!-- 実際に使った金額 入力フォーム or 入力済み表示 -->
    <div class="mt-6 flex flex-col items-center w-full max-w-xs mx-auto">
      <% if @draw.actual_amount.present? %>
        <div class="text-lg text-secondary bg-secondary/10 rounded-lg px-6 py-3 font-semibold">
          今日使った金額：<span class="text-accent font-bold"><%= @draw.actual_amount %>円</span><br>
        </div>
      <% else %>
        <%= form_with model: @draw, url: draw_path(@draw), method: :patch, local: true, class: "w-full" do %>
          <div class="flex flex-col items-center gap-3">
            <label for="actual_amount" class="font-semibold text-secondary">実際に使った金額を入力しよう！</label>
            <%= number_field_tag "actual_amount", nil, min: 0, required: true,
              class: "border rounded px-3 py-2 text-center w-32 text-lg" %>
            <%= submit_tag "保存", class: "mt-1 bg-secondary text-white px-5 py-2 rounded font-bold hover:bg-secondary/80 transition" %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- モーダル画面 -->
  <% if @draw %>
    <!-- 暗転背景 -->
    <div id="modal-bg" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40"
      style="<%= flash[:draw_amount] ? '' : 'display:none;' %>"></div>

    <!-- モーダル本体 -->
    <div id="draw-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-xl p-4 md:p-8 text-center z-50 border-4 border-primary ring-2 ring-primary/30  w-11/12 max-w-md md:w-full md:max-w-xl overflow-y-auto animate-fadein-modal"
      style="<%= flash[:draw_amount] ? '' : 'display:none;' %>">

      <!-- ここ：カプセル用コンテナを追加 -->
      <div id="capsule-container" class="relative w-full h-8 overflow-visible z-[51]"></div>

      <!-- 金額表示 -->
      <div class="flex justify-center items-center text-secondary  whitespace-nowrap text-2xl sm:text-3xl md:text-4xl font-bold mb-10 gap-1">
        <span class="animate-bounce">🎉</span>
        <span>今日のガチャ結果</span>
        <span class="animate-bounce">🎉</span>
      </div>

      <div id="amount-card" class="relative w-70 h-24 mx-auto mb-4 overflow-visible bg-primary rounded-full shadow-md">
        <!-- 裏面の背景（文字なし） -->
        <div class="back-surface absolute inset-0 rounded-full bg-primary" aria-hidden="true"></div>
        <!-- 実際の金額 -->
        <div id="real-amount"
            class="absolute inset-0 flex items-center justify-center backface-hidden
                    text-6xl text-white font-extrabold drop-shadow-lg leading-none gap-x-1 whitespace-nowrap">
          <!-- JS で 0 → 金額 をカウントアップしてセットします -->
          <span id="real-number" class="mr-1">0</span><span>円</span>
        </div>
      </div>

      <!-- ランダムメッセージ -->
      <div id="draw-message"
           class="opacity-0 transition-opacity duration-900 ease-out text-base mt-6 text-yellow-300 font-semibold animate-bounce">
        <%= @draw_message %>
      </div>

      <!-- 各導線 -->
      <div class="space-y-5 flex flex-col items-center w-full max-w-sm mx-auto mt-10">
        <!-- お店を探す -->
        <div class="flex items-center justify-center gap-4 w-full">
          <span class="inline-flex items-center justify-center w-10 h-10 text-primary text-2xl">
            <i class="fa-solid fa-utensils"></i>
          </span>
          <%= link_to search_path, class: "flex flex-col items-start justify-center" do %>
            <span class="font-bold text-base hover:text-gray-500">近くのお店を探す</span>
          <% end %>
        </div>
        <!-- Xで共有 -->
        <div class="flex items-center justify-center gap-4 w-full ml-2">
          <span class="inline-flex items-center justify-center w-10 h-10">
            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 50 50">
            <path d="M 11 4 C 7.134 4 4 7.134 4 11 L 4 39 C 4 42.866 7.134 46 11 46 L 39 46 C 42.866 46 46 42.866 46 39 L 46 11 C 46 7.134 42.866 4 39 4 L 11 4 z M 13.085938 13 L 21.023438 13 L 26.660156 21.009766 L 33.5 13 L 36 13 L 27.789062 22.613281 L 37.914062 37 L 29.978516 37 L 23.4375 27.707031 L 15.5 37 L 13 37 L 22.308594 26.103516 L 13.085938 13 z M 16.914062 15 L 31.021484 35 L 34.085938 35 L 19.978516 15 L 16.914062 15 z"></path>
            </svg>
          </span>
          <a href="#" class="flex flex-col items-start justify-center">
            <span class="font-bold text-base hover:text-gray-500">結果をXで共有する</span>
            <span class="text-xs text-gray-400">（近日実装）</span>
          </a>
        </div>
      </div>
      <!-- モーダル閉じるボタン -->
      <div class="mt-6">
        <button
          id="close-modal-btn" class="text-sm text-gray-400 underline hover:text-secondary hover:bg-gray-100 px-4 py-2 rounded transition">
          閉じる
        </button>
      </div>
    </div>
  <% end %>
</main>

<%= javascript_include_tag "main", "data-turbo-track": "reload" %>
