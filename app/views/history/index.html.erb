<% content_for :title, "履歴" %>
<h1 class="text-xl font-bold m-4 text-secondary">ガチャ履歴</h1>
<main class="mx-auto w-full max-w-6xl px-4 mb-28 md:mb-22 text-gray-700">

  <!-- 月ナビとサマリ（カレンダーの上） -->
  <div class="flex items-center justify-between gap-4 mb-4 md:mb-6">
    <div class="flex items-center gap-3">
      <% prev_month = @month.prev_month.strftime("%Y-%m") %>
      <% next_month = @month.next_month.strftime("%Y-%m") %>
      <%= link_to "← 前の月", history_path(month: prev_month), class: "text-sm md:text-base text-primary hover:underline" %>
    </div>

    <h1 class="text-xl md:text-2xl font-extrabold text-primary"><%= @month.strftime("%Y年%-m月") %></h1>

    <div class="flex items-center gap-3">
      <% if @month.next_month <= Date.current.beginning_of_month %>
        <%= link_to "次の月 →", history_path(month: next_month), class: "text-sm md:text-base text-primary hover:underline" %>
      <% else %>
        <span class="text-gray-300 text-sm md:text-base">次の月 →</span>
      <% end %>
    </div>
  </div>

  <% month_diff = @sum_amount - @sum_actual %>
  <% cumulative_diff = @all_draws.sum { |d| d.amount - (d.actual_amount || d.amount) } %>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
    <div class="rounded-xl border border-gray-200 p-3 shadow-sm">
      <div class="text-xs font-bold text-secondary">今月の予算合計</div>
      <div class="text-lg md:text-xl font-bold"><%= @sum_amount %>円</div>
    </div>
    <div class="rounded-xl border border-gray-200 p-3 shadow-sm">
      <div class="text-xs font-bold text-secondary">今月使ったお金</div>
      <div class="text-lg md:text-xl font-bold"><%= @sum_actual %>円</div>
    </div>
    <div class="rounded-xl border border-gray-200 p-3 mb-2 md:mb-0 shadow-sm">
      <div class="text-xs font-bold text-secondary">今月の差額合計</div>
      <div class="text-lg md:text-xl font-bold <%= month_diff > 0 ? 'text-green-400' : month_diff < 0 ? 'text-accent' : '' %>">
        <%= month_diff == 0 ? '±0円' : "#{month_diff > 0 ? '+' : ''}#{month_diff}円" %>
      </div>
    </div>
    <div class="text-center rounded-full border-6 border-primary p-3 shadow-sm">
      <div class="text-xs font-bold">トータル差額合計</div>
      <div class="text-lg md:text-xl font-bold <%= cumulative_diff > 0 ? 'text-green-400' : cumulative_diff < 0 ? 'text-accent' : '' %>">
        <%= cumulative_diff == 0 ? '±0円' : "#{cumulative_diff > 0 ? '+' : ''}#{cumulative_diff}円" %>
      </div>
    </div>
  </div>

  <!-- カレンダー用の日付配列 -->
  <% start_date = @month.beginning_of_month.beginning_of_week(:sunday) %>
  <% end_date   = @month.end_of_month.end_of_week(:sunday) %>
  <% days = (start_date..end_date).to_a %>
  <% draws_by_date = @draws.index_by(&:date) %>

  <!-- 横スクロール対応ラッパー（スマホ） -->
  <div class="-mx-4 px-4 overflow-x-auto md:overflow-visible md:mx-0 md:px-0">
    <div class="min-w-[700px] md:min-w-0">

      <!-- 曜日ヘッダ -->
      <div class="grid grid-cols-7 gap-2 md:gap-3 text-center text-[10px] sm:text-xs md:text-sm font-bold mb-2 md:mb-3">
        <% %w(日 月 火 水 木 金 土).each_with_index do |w, i| %>
          <div class="<%= i == 0 ? 'text-red-500' : i == 6 ? 'text-blue-600' : '' %>"><%= w %></div>
        <% end %>
      </div>

      <!-- 日付グリッド -->
      <div class="grid grid-cols-7 gap-2 md:gap-3">
        <% days.each do |date| %>
          <% draw     = draws_by_date[date] %>
          <% undrawn  = draw.nil? %>
          <% in_month = (date.month == @month.month) %>
          <% is_today = (date == Date.current) %>
          <% wday     = date.wday %>
          <% diff     = draw ? (draw.amount - (draw.actual_amount || draw.amount)) : 0 %>

          <button
            type="button"
            class="
              group relative w-full min-w-[96px] rounded-xl border p-2 md:p-3 text-left
              <%= undrawn ? 'bg-gray-100' : 'bg-white' %> shadow-sm hover:shadow transition
              <%= in_month ? '' : 'opacity-30' %>
              <%= is_today ? 'ring-3 ring-primary/60' : '' %>
            "
            data-date="<%= date.strftime('%Y-%m-%d') %>"
            data-draw-id="<%= draw&.id %>"
            data-draw-amount="<%= draw&.amount %>"
            data-actual-amount="<%= draw&.actual_amount %>"
            title="<%= date.strftime('%-m/%-d') %>"
            onclick="window.handleDaySelect && window.handleDaySelect(this)"
          >
            <!-- 日付 -->
            <div class="flex items-center justify-between mb-1">
              <div class="text-[10px] sm:text-xs font-bold <%= wday == 0 ? 'text-red-500' : wday == 6 ? 'text-blue-600' : 'text-gray-600' %>">
                <span class="whitespace-nowrap"><%= date.strftime("%-m/%-d") %></span>
              </div>
              <% if is_today %>
                <span class="text-[10px] sm:text-xs px-1.5 rounded bg-primary/10 text-primary">今日</span>
              <% end %>
            </div>

            <!-- 金額3種（スマホはラベル省略＆行間詰め） -->
            <div class="space-y-0.5 md:space-y-1 text-[11px] sm:text-xs md:text-sm leading-tight">
              <div class="flex justify-between items-baseline">
                <span class="text-gray-500">予算</span>
                <span class="font-semibold tabular-nums whitespace-nowrap"><%= draw&.amount ? "#{draw.amount}円" : '-' %></span>
              </div>
              <div class="flex justify-between items-baseline">
                <span class="text-gray-500">使用</span>
                <span class="font-semibold tabular-nums whitespace-nowrap">
                  <% if undrawn %>
                    -
                  <% elsif draw.actual_amount.present? %>
                    <%= "#{draw.actual_amount}円" %>
                  <% else %>
                    未入力
                  <% end %>    
                </span>
              </div>
              <div class="flex justify-between items-baseline">
                <span class="text-gray-500">差額</span>
                <% if draw %>
                  <span class="font-bold tabular-nums whitespace-nowrap <%= diff > 0 ? 'text-green-400' : diff < 0 ? 'text-accent' : 'text-gray-700' %>">
                    <%= diff == 0 ? '±0円' : "#{diff > 0 ? '+' : ''}#{diff}円" %>
                  </span>
                <% else %>
                  <span class="font-semibold">-</span>
                <% end %>
              </div>
            </div>

            <!-- セル選択のビジュアル -->
            <span class="pointer-events-none absolute inset-0 rounded-xl ring-0 group-[.is-selected]:ring-2 group-[.is-selected]:ring-secondary transition"></span>
          </button>
        <% end %>
      </div>

    </div>
  </div>

  <!-- 編集フォーム（カレンダー下） -->
  <div class="mt-6 md:mt-8 rounded-2xl border border-gray-200 p-4 md:p-5 shadow">
    <div class="mb-3 md:mb-4">
      <div class="text-base font-bold text-secondary">使用金額の編集</div>
      <div class="text-xs text-gray-400">※カレンダーで日付を選択して入力してください</div>
    </div>

    <%= form_with url: '#',
                  method: :post,
                  local: true,
                  html: { id: "edit-actual-form",
                          class: "grid grid-cols-1 sm:grid-cols-3 gap-3 items-end" },
                  data: { update_base: '/draws' } do %>

      <%= hidden_field_tag :_method, 'patch' %>
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <%= hidden_field_tag :id, nil, id: "edit-draw-id" %>

      <div>
        <label class="block text-sm font-bold mb-1">対象日</label>
        <input id="edit-date-display" type="text"
               class="w-full rounded-lg border px-3 py-2 bg-gray-50" value="未選択" disabled>
      </div>

      <div>
        <label for="actual_amount" class="block text-sm font-bold mb-1">使用金額（円）</label>
        <%= number_field_tag :actual_amount, nil, min: 0,
              class: "w-full rounded-lg border px-3 py-2", id: "actual_amount" %>
      </div>

      <div>
        <button type="submit"
                class="w-full rounded-lg bg-secondary text-white font-bold px-4 py-2 hover:bg-secondary/80 transition disabled:opacity-50"
                id="save-btn" disabled>保存</button>
      </div>
    <% end %>
  </div>
</main>

<%= javascript_include_tag "history", "data-turbo-track": "reload" %>
